# 卡尔曼滤波公式推导

在离散状态空间表示下，加入噪声的系统可以有如下表示：
$$
\begin{cases}
X_k=AX_{k-1}+Bu_k+w_k \\
Z_k=HX_k+v_k
\end{cases}
$$
其中$w_k \sim \text{N}(0, Q)$为过程噪声，$v_k \sim \text{N}(0, R)$为测量噪声，$Q、R$分别为$w_k、v_k$的协方差矩阵

> 提醒：协方差矩阵是对称矩阵，其转置和自身相等

**卡尔曼滤波是一种递归估计的思想，即我们假设在$k-1$时刻得到了系统状态$X_{k-1}$的最优估计值$\hat{X}_{k-1}$，我们如何推导出$k$时刻的系统状态$X_k$的最优估计值$\hat{X}_{k}$**

定义$\hat{X}_{k-1}$为$k-1$时刻的后验估计值（最优估计值），则我们可以得到$k$时刻的两种系统状态的估计值
$$
\begin{align}
\hat{X}_k^{-}&=A\hat{X}_{k-1}+Bu_k \\
\hat{X}_{kmea}&=H^{-1}Z_k
\end{align}
$$
其中$\hat{X}_k^{-}$称为$k$时刻的先验估计，它忽略了系统的过程噪声，$\hat{X}_{kmea}$称为$k$时刻的测量估计，它忽略了系统的测量噪声

现在我们有了两个关于$X_k$的估计值，我们需要将其组合起来获取最优的那个估计值，即选取合适的$G_k$，使得
$$
\hat{X}_k=\hat{X}_k^-+G_k(\hat{X}_{kmea}-\hat{X}_k^-)
$$
更趋近于$X_k$

我们令$K_k=G_kH$为卡尔曼增益矩阵，同时带入$\hat{X}_{kmea}=H^{-1}Z_k$，有
$$
\hat{X}_k=\hat{X}_k^-+K_k(Z_k-H\hat{X}_k^-)
$$
定义后验误差
$$
\hat{e}_k=X_k-\hat{X}_k
$$
显然有$\hat{e}_k \sim \text{N}(0, \hat{P_k})$，$\hat{P_k}$为后验误差的协方差矩阵，其形式如下
$$
\hat{P_k}=\begin{bmatrix} \sigma e_1^2 & \sigma e_1e_2 & \cdots & \sigma e_1e_n \\ \sigma e_2e_1 & \sigma e_2^2 & \cdots & \sigma e_2e_n \\ \vdots & \vdots & \ddots & \vdots\\ \sigma e_ne_1 & \sigma e_ne_2 & \cdots &\sigma e_n^2\end{bmatrix}
$$
由方差的定义我们可以知道，协方差矩阵对角线之外的协方差项仅表示误差分量的变化方向趋势，只有对角线上的方差项表示误差关于某一个值的变化程度

所以若我们想要$\hat{X}_k$尽可能趋近于$X_k$，即有后验误差的协方差矩阵$\hat{P_k}$对角线上的方差项之和尽可能小，即$\text{tr}(\hat{P_k})$最小

由协方差矩阵的计算方法我们可以得到（下式中的$\text{E}()$表示期望）
$$
\begin{align}
\hat{P_k} &=\text{E}(\hat{e}_k\hat{e}_k^T) \\
&=\text{E}((X_k-\hat{X}_k)(X_k-\hat{X}_k)^T) \\
&=\text{E}((X_k-\hat{X}_k^--K_k(Z_k-H\hat{X}_k^-))(X_k-\hat{X}_k^--K_k(Z_k-H\hat{X}_k^-))^T) \\
&=\text{E}((X_k-\hat{X}_k^--K_k(HX_k+v_k-H\hat{X}_k^-)(X_k-\hat{X}_k^--K_k(HX_k+v_k-H\hat{X}_k^-)^T) \\
&=\text{E}(((I-K_kH)(X_k-\hat{X}_k^{-})-K_kv_k)((I-K_kH)(X_k-\hat{X}_k^{-})-K_kv_k)^T)
\end{align}
$$
定义先验误差
$$
\hat{e}_k^{-}=X_k-\hat{X}_k^-
$$
有
$$
\begin{align}
\hat{P_k} 
&=\text{E}(((I-K_kH)\hat{e}_k^{-}-K_kv_k)((I-K_kH)\hat{e}_k^{-}-K_kv_k)^T) \\
&=\text{E}(((I-K_kH)\hat{e}_k^{-}-K_kv_k)((\hat{e}_k^{-})^T(I-H^TK_k^T)-v_k^TK_k^T)) \\
&=\text{E}((I-K_kH)\hat{e}_k^{-}(\hat{e}_k^{-})^T(I-H^TK_k^T) - K_kv_k(\hat{e}_k^{-})^T(I-H^TK_k^T) - (I-K_kH)\hat{e}_k^{-}v_k^TK_k^T + K_kv_kv_k^TK_k^T) \\
&=(I-K_kH)\text{E}(\hat{e}_k^{-}(\hat{e}_k^{-})^T)(I-H^TK_k^T)-K_k\text{E}(v_k(\hat{e}_k^{-})^T)(I-H^TK_k^T)-(I-K_kH)\text{E}(\hat{e}_k^{-}v_k^T)K_k^T+K_k\text{E}(v_kv_k^T)K_k^T
\end{align}
$$

在前面我们定义了后验误差的协方差矩阵$\hat{P_k} =\text{E}(\hat{e}_k\hat{e}_k^T)$，这里我们定义先验误差的协方差矩阵
$$
\hat{P^{-}_k} =\text{E}(\hat{e}_k^{-}(\hat{e}_k^{-})^T)
$$
同时我们知道$v_k、(\hat{e}_k^{-})^T$互相独立，$\hat{e}_k^{-}、v_k^T$互相独立，又有$\text{E}(v_k)=\text{E}(v_k^T)=0$所以有
$$
\begin{align}
\text{E}(v_k(\hat{e}_k^{-})^T)&=\text{E}(v_k)\text{E}((\hat{e}_k^{-})^T)=0 \\
\text{E}(\hat{e}_k^{-}v_k^T)&=\text{E}(\hat{e}_k^{-})\text{E}(v_k^T)=0
\end{align}
$$
此外，有
$$
\text{E}(v_kv_k^T)=R
$$
则有
$$
\begin{align}
\hat{P_k}
&=(I-K_kH)\hat{P_k^{-}}(I-H^TK_k^T)+K_kRK_k^T \\
&=(\hat{P_k^{-}}-K_kH\hat{P_k^{-}})(I-H^TK_k^T)+K_kRK_k^T \\
&=\hat{P_k^{-}}-K_kH\hat{P_k^{-}}-\hat{P_k^{-}}H^TK_k^T+K_kH\hat{P_k^{-}}H^TK_k^T+K_kRK_k^T \\
\end{align}
$$
我们计算$\text{tr}(\hat{P_k})$
$$
\begin{align}
\text{tr}(\hat{P_k})
&=\text{tr}(\hat{P_k^{-}})-\text{tr}(K_kH\hat{P_k^{-}})-\text{tr}(\hat{P_k^{-}}H^TK_k^T)+\text{tr}(K_kH\hat{P_k^{-}}H^TK_k^T)+\text{tr}(K_kRK_k^T)
\end{align}
$$
我们考虑$K_kH\hat{P_k^{-}}$和$\hat{P_k^{-}}H^TK_k^T$两个矩阵
$$
\begin{align}
(\hat{P_k^{-}}H^TK_k^T)^{T}=K_kH(\hat{P_k^{-}})^T=K_kH\hat{P_k^{-}}
\end{align}
$$
所以上面两个矩阵互为转置，那么其秩就是一样的，所以有
$$
\text{tr}(\hat{P_k})
=\text{tr}(\hat{P_k^{-}})-2\text{tr}(K_kH\hat{P_k^{-}})+\text{tr}(K_kH\hat{P_k^{-}}H^TK_k^T)+\text{tr}(K_kRK_k^T)
$$
要使$\text{tr}(\hat{P_k})$最小，我们让$\text{tr}(\hat{P_k})$对$K_k$求导
$$
\begin{align}
\frac{\text{d}\text{tr}(\hat{P_k})}{\text{d}K_k}
&=\frac{\text{d}(\text{tr}(\hat{P_k^{-}})-2\text{tr}(K_kH\hat{P_k^{-}})+\text{tr}(K_kH\hat{P_k^{-}}H^TK_k^T)+\text{tr}(K_kRK_k^T))}{\text{d}K_k} \\
&=\frac{\text{d}\text{tr}(\hat{P_k^{-}})}{\text{d}K_k}-2\frac{\text{d}\text{tr}(K_kH\hat{P_k^{-}})}{\text{d}K_k}+\frac{\text{d}\text{tr}(K_kH\hat{P_k^{-}}H^TK_k^T)}{\text{d}K_k}+\frac{\text{d}\text{tr}(K_kRK_k^T)}{\text{d}K_k} \\
\end{align}
$$
现在讨论每一项

显然$\text{tr}(\hat{P_k^{-}})$跟$K_k$没有任何关系，所以第一项为$0$

对于后面几项，我们有以下关于矩阵的迹的求导公式
$$
\begin{align}
\frac{\text{dtr}(AB)}{\text{d}A}&=\frac{\text{dtr}(BA)}{\text{d}A}=B^T \\
\frac{\text{dtr}(ABA^T)}{\text{d}A}&=AB+AB^T \\
\end{align}
$$
故有
$$
\begin{align}
\frac{\text{d}\text{tr}(\hat{P_k})}{\text{d}K_k}
&=-2(H\hat{P_k^{-}})^T+K_kH\hat{P_k^{-}}H^T+K_k(H\hat{P_k^{-}}H^T)^T+K_kR+K_kR^T \\
&=-2\hat{P_k^{-}}H^T+2K_kH\hat{P_k^{-}}H^T+2K_kR
\end{align}
$$
我们令
$$
\frac{\text{d}\text{tr}(\hat{P_k})}{\text{d}K_k}=0
$$
有
$$
\begin{aligned}
& &-2\hat{P_k^{-}}H^T+2K_kH\hat{P_k^{-}}H^T+2K_kR &=0 \\
&\Rightarrow & K_k(H\hat{P_k^{-}}H^T+R) &=\hat{P_k^{-}}H^T \\
&\Rightarrow & K_k&=\frac{\hat{P_k^{-}}H^T}{H\hat{P_k^{-}}H^T+R}
\end{aligned}
$$
至此，我们得到了卡尔曼增益矩阵的表示方法，这能让我们的后验估计最接近真实值

但卡尔曼增益矩阵中的$\hat{P_k^{-}}$项仍然未知，所以我们现在计算这一项

由定义知
$$
\begin{align}
\hat{P^{-}_k} 
&=\text{E}(\hat{e}_k^{-}(\hat{e}_k^{-})^T) \\
&=\text{E}((X_k-\hat{X}_k^-)(X_k-\hat{X}_k^-)^T) \\
&=\text{E}((AX_{k-1}+Bu_k+w_k-A\hat{X}_{k-1}+Bu_k)(AX_{k-1}+Bu_k+w_k-A\hat{X}_{k-1}+Bu_k)^T) \\
&=\text{E}((A\hat{e}_{k-1}+w_k)(A\hat{e}_{k-1}+w_k)^T) \\
&=\text{E}((A\hat{e}_{k-1}+w_k)(w_k^T+\hat{e}_{k-1}^TA^T)) \\
&=\text{E}(A\hat{e}_{k-1}w_k^T+A\hat{e}_{k-1}\hat{e}_{k-1}^TA^T+w_kw_k^T+w_k\hat{e}_{k-1}^TA^T) \\
&=A\text{E}(\hat{e}_{k-1}w_k^T)+A\text{E}(\hat{e}_{k-1}\hat{e}_{k-1}^T)A^T+\text{E}(w_kw_k^T)+\text{E}(w_k\hat{e}_{k-1}^T)A^T \\
\end{align}
$$
我们同样是分开看每一项，显然$\hat{e}_{k-1}、w_k^T$互相独立，$w_k、\hat{e}_{k-1}^T$互相独立，又有$\text{E}(w_k^T)=\text{E}(w_k)=0$，所以有
$$
\begin{align}
\text{E}(\hat{e}_{k-1}w_k^T)&=\text{E}(\hat{e}_{k-1})\text{E}(w_k^T)=0 \\
\text{E}(w_k\hat{e}_{k-1}^T)&=\text{E}(w_k)\text{E}(\hat{e}_{k-1}^T)=0 \\
\end{align}
$$
此外，有
$$
\text{E}(w_kw_k^T)=Q \\
\text{E}(\hat{e}_{k-1}\hat{e}_{k-1}^T)=\hat{P}_{k-1}
$$
则有
$$
\hat{P^{-}_k}=A\hat{P}_{k-1}A^T+Q
$$
下面我们计算后验误差的协方差矩阵$\hat{P_k} $

$$
\begin{align}
\hat{P_k}
&=\hat{P_k^{-}}-K_kH\hat{P_k^{-}}-\hat{P_k^{-}}H^TK_k^T+K_kH\hat{P_k^{-}}H^TK_k^T+K_kRK_k^T \\
&=(I-K_kH)\hat{P_k^{-}}-(\hat{P_k^{-}}H^T-K_kH\hat{P_k^{-}}H^T-K_kR)K_k^T \\
&=(I-K_kH)\hat{P_k^{-}}-(\hat{P_k^{-}}H^T-K_k(H\hat{P_k^{-}}H^T+R))K_k^T \\
&=(I-K_kH)\hat{P_k^{-}}-(\hat{P_k^{-}}H^T-\hat{P_k^{-}}H^T)K_k^T \\
&=(I-K_kH)\hat{P_k^{-}}
\end{align}
$$
至此，我们得到了卡尔曼的五个公式，其使用顺序如下

初始状态$k=0$的情况下，我们有给定的初始值$\hat{X}_{0}$与初始后验误差协方差矩阵$\hat{P_0}$，这两个初始值矩阵一般为零，还有设定的过程噪声的协方差矩阵$Q$，测量噪声的协方差矩阵$R$，这两个矩阵需要我们给定一个初始值

当$k \geqslant 1$时，有

第一步，计算此时的先验估计
$$
\hat{X}_k^{-}=A\hat{X}_{k-1}+Bu_k
$$
第二步，计算此时先验误差的协方差矩阵
$$
\hat{P^{-}_k}=A\hat{P}_{k-1}A^T+Q
$$
第三步，计算此时的卡尔曼增益
$$
K_k=\frac{\hat{P_k^{-}}H^T}{H\hat{P_k^{-}}H^T+R}
$$
第四步，计算此时的后验估计（此时刻系统状态的最优估计）
$$
\hat{X}_k=\hat{X}_k^-+K_k(Z_k-H\hat{X}_k^-)
$$
第五步，计算此时后验误差的协方差矩阵
$$
\hat{P_k}=(I-K_kH)\hat{P_k^{-}}
$$






















